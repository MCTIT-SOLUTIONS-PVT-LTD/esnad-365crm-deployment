name: ğŸš€ Deploy CRM Solution (On-Prem)

on:
  push:
    branches:
      - DEV
    paths:
      - 'Solutions/**'
  workflow_dispatch:
    inputs:
      solution:
        description: 'Path to unmanaged solution ZIP'
        required: true
        default: 'Solutions/EsnadCICD_1_0_0_1.zip'

jobs:
  deploy-crm:
    runs-on: self-hosted  # ğŸ‘ˆ This uses your self-hosted GitHub Actions runner

    steps:
      - name: â¬‡ï¸ Step 1 - Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Step 2 - Show Working Directory and Files
        shell: powershell
        run: |
          Write-Host "ğŸ“‚ Working Directory: $PWD"
          Get-ChildItem -Recurse

      - name: âœ… Step 3 - Verify Solution File Exists
        shell: powershell
        run: |
          $solutionInput = "${{ github.event.inputs.solution }}"
          $solutionPath = if ($solutionInput) { $solutionInput } else { 'Solutions/EsnadCICD_1_0_0_1.zip' }
          Write-Host "ğŸ” Checking for solution file at: $solutionPath"
          if (-not (Test-Path $solutionPath)) {
            throw "âŒ Solution file not found: $solutionPath"
          } else {
            Write-Host "âœ… Solution file found: $solutionPath"
          }

      - name: ğŸ›  Step 4 - Import Solution to Dynamics 365 On-Prem
        shell: powershell
        run: |
          $solutionInput = "${{ github.event.inputs.solution }}"
          $solutionPath = if ($solutionInput) { $solutionInput } else { 'Solutions/EsnadCICD_1_0_0_1.zip' }

          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "ğŸ“¦ Starting solution import..."
          Write-Host "ğŸ”— Connection: $($connectionString.Substring(0,60))..."
          Write-Host "ğŸ“ Solution Path: $solutionPath"

          Import-CrmSolution `
            -ConnectionString $connectionString `
            -SolutionFilePath $solutionPath `
            -OverwriteUnmanagedCustomizations:$true `
            -PublishWorkflows:$true

          Write-Host "âœ… Solution import completed successfully."

      - name: ğŸ“¢ Step 5 - Publish All Customizations (Optional)
        shell: powershell
        run: |
          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "ğŸš€ Publishing all customizations..."
          Publish-CrmAllCustomizations -ConnectionString $connectionString
          Write-Host "âœ… Publish completed."
