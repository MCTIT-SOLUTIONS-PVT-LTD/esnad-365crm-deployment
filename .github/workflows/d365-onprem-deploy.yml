name: Deploy D365 Unmanaged Solution (On-Prem)

on:
  push:
    branches:
      - main
    paths:
      - 'Solutions/**'   # Only trigger if solution ZIP is pushed
  workflow_dispatch:
    inputs:
      solution:
        description: "Unmanaged solution ZIP path"
        required: true
        default: "Solutions/EsnadCICD_1_0_0_0.zip"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v3

      - name: üìÇ Show Files in Solutions Folder
        shell: pwsh
        run: |
          Get-ChildItem "${{ github.workspace }}/Solutions"

      - name: üõ† Import Unmanaged Solution to D365 On-Prem
        shell: pwsh
        run: |
          $solutionPath = "${{ github.workspace }}/${{ github.event.inputs.solution || 'Solutions/EsnadCICD_1_0_0_0.zip' }}"
          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "üîÅ Importing solution: $solutionPath"
          Write-Host "üîí Connecting to CRM: $crmUrl"

          try {
            Import-CrmSolution -ConnectionString $connectionString -SolutionFilePath $solutionPath -PublishWorkflows:$true -Verbose
            Write-Host "‚úÖ Solution import completed"
          } catch {
            Write-Error "‚ùå Import failed: $_"
            exit 1
          }
