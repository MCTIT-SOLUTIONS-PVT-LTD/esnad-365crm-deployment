name: ğŸš€ Deploy CRM Solution (On-Prem)

on:
  push:
    branches:
      - DEV
    paths:
      - 'Solutions/**'
  workflow_dispatch:
    inputs:
      solution:
        description: 'Path to unmanaged solution ZIP'
        required: true
        default: 'Solutions/EsnadCICD_1_0_0_1.zip'

jobs:
  deploy-crm:
    runs-on: self-hosted  # Ensure this agent has Dynamics 365 SDK tools installed

    steps:
      - name: â¬‡ï¸ Step 1 - Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Step 2 - Show Working Directory and Files
        shell: pwsh
        run: |
         Write-Host "ğŸ¯ Workflow started"
          Write-Host "`nğŸ“‚ Working Directory: $PWD"
          Get-ChildItem -Recurse

      - name: âœ… Step 3 - Verify Solution File Exists
        shell: pwsh
        run: |
        
          $solutionInput = "${{ github.event.inputs.solution }}"
          if ([string]::IsNullOrWhiteSpace($solutionInput)) {
            $solutionInput = 'Solutions/EsnadCICD_1_0_0_1.zip'
          }

          $solutionPath = Join-Path "${{ github.workspace }}" $solutionInput
          Write-Host "`nğŸ” Checking for solution file at: $solutionPath"
          if (-not (Test-Path $solutionPath)) {
            throw "âŒ Solution file not found: $solutionPath"
          } else {
            Write-Host "âœ… Solution file found: $solutionPath"
          }

      - name: ğŸ›  Step 4 - Import Solution to D365 On-Prem
        shell: pwsh
        run: |
        
          $solutionInput = "${{ github.event.inputs.solution }}"
          if ([string]::IsNullOrWhiteSpace($solutionInput)) {
            $solutionInput = 'Solutions/EsnadCICD_1_0_0_1.zip'
          }

          $solutionPath = Join-Path "${{ github.workspace }}" $solutionInput
          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          Write-Host "`nğŸ”‘ Building connection string"
          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "`nğŸ“¦ Starting solution import..."
          Write-Host "ğŸ”— CRM URL: $crmUrl"
          Write-Host "ğŸ“ Solution Path: $solutionPath"

          Import-CrmSolution `
            -ConnectionString $connectionString `
            -SolutionFilePath $solutionPath `
            -OverwriteUnmanagedCustomizations:$true `
            -PublishWorkflows:$true

          Write-Host "âœ… Solution import completed successfully."

      - name: ğŸ“¢ Step 5 - Publish All Customizations (Optional)
        shell: pwsh
        run: |
          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "`nğŸš€ Publishing all customizations..."
          Publish-CrmAllCustomizations -ConnectionString $connectionString
          Write-Host "âœ… Publish completed."

      - name: ğŸ“ Step 6 - Log Import Metadata
        shell: pwsh
        run: |
          Write-Host "`nğŸ§¾ Logging import metadata"
          Write-Host "ğŸ•’ Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "ğŸ“¦ Solution File: ${{ github.event.inputs.solution }}"
          Write-Host "ğŸ‘¤ Imported By: GitHub Actions (CI/CD Pipeline)"
