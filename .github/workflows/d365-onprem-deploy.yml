name: Deploy D365 Unmanaged Solution (On-Prem)

on:
  push:
    branches:
      - dev
    paths:
      - 'Solutions/**'   # Only trigger if solution ZIP is pushed
  workflow_dispatch:
    inputs:
      solution:
        description: "Unmanaged solution ZIP path"
        required: true
        default: "Solutions/EsnadCICD_1_0_0_0.zip"

jobs:
  deploy-d365-dev:
    runs-on: self-hosted

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ“‚ Show Files in Solutions Folder
        shell: pwsh
        run: |
          Get-ChildItem "${{ github.workspace }}/Solutions"

      - name: ğŸ›  Import Unmanaged Solution to D365 On-Prem
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Setting variables"
          $solutionPath = "${{ github.workspace }}/${{ github.event.inputs.solution || 'Solutions/EsnadCICD_1_0_0_0.zip' }}"
          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          Write-Host "ğŸ”‘ Building connection string"
          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "ğŸ” Importing solution from path: $solutionPath"
          Write-Host "ğŸ”’ Connecting to CRM: $crmUrl"
          Write-Host "ğŸ“¡ Connection String:"
          Write-Host $connectionString

          try {
            Write-Host "ğŸš€ Executing Import-CrmSolution"
            Import-CrmSolution -ConnectionString $connectionString -SolutionFilePath $solutionPath -PublishWorkflows:$true -Verbose
            Write-Host "âœ… Solution import completed"
          } catch {
            Write-Error "âŒ Import failed: $_"
            exit 1
          }
