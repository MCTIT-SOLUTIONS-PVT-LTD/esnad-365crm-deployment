name: Deploy D365 Unmanaged Solution (On-Prem)

on:
  push:
    branches:
      - dev
    paths:
      - 'Solutions/**'   # Only trigger when solution zip is pushed
  workflow_dispatch:
    inputs:
      solution:
        description: "Unmanaged solution ZIP path"
        required: true
        default: "Solutions/EsnadCICD_1_0_0_0.zip"

jobs:
  deploy-d365-dev:
    runs-on: self-hosted

    steps:
      - name: Hello World Test
        run: echo "âœ… GitHub Actions workflow has started successfully"

      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ“‚ Show Files in Solutions Folder
        shell: pwsh
        run: |
          Write-Host "ğŸ“ Listing contents of the Solutions folder:"
          Get-ChildItem "${{ github.workspace }}/Solutions" | ForEach-Object { Write-Host $_.FullName }

      - name: ğŸ›  Import Unmanaged Solution to D365 On-Prem
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Setting variables"

          # Get solution path (manual input or default)
          $solutionPath = "${{ github.workspace }}/" + (${{
            github.event.inputs.solution != '' && github.event.inputs.solution || 'Solutions/EsnadCICD_1_0_0_0.zip'
          }})

          $crmUrl = "${{ vars.D365DEV_ENV_URL }}"
          $username = "${{ vars.D365DEV_USERNAME }}"
          $password = "${{ vars.D365DEV_PASSWORD }}"

          Write-Host "`nğŸ”‘ Building connection string"
          $connectionString = @"AuthType=IFD;Url=$crmUrl;Domain=crm-esnad.com;Username=$username;Password=$password;HomeRealmUri=https://sts1.crm-esnad.com/adfs/services/trust/13/usernamemixed;RequireNewInstance=true;"@

          Write-Host "`nğŸ” Importing solution from path: $solutionPath"
          Write-Host "ğŸ”’ Connecting to CRM: $crmUrl"
          Write-Host "ğŸ“¡ Connection String:"; Write-Host $connectionString

          try {
            Write-Host "ğŸš€ Executing Import-CrmSolution"
            Import-CrmSolution -ConnectionString $connectionString -SolutionFilePath $solutionPath -PublishWorkflows:$true -Verbose
            Write-Host "âœ… Solution import completed successfully"
          } catch {
            Write-Error "âŒ Import failed: $_"
            exit 1
          }
